# ROUTE PROTECTION GUIDE

## How to Apply Auth Middleware

### Step 1: Import the middleware at the top of routes.ts

```typescript
import { 
  requireAuth, 
  requireAdmin, 
  requireHauler, 
  requireCustomer, 
  requireOwnership,
  requireHaulerOwnership,
  optionalAuth 
} from "./auth-middleware";
```

### Step 2: Apply middleware to routes

Change this pattern:
```typescript
app.get("/api/some-route", async (req, res) => {
```

To this pattern:
```typescript
app.get("/api/some-route", requireAuth, async (req, res) => {
//                         ^^^^^^^^^^^^ Add middleware here
```

---

## ADMIN ROUTES (Require Admin Role)

**Pattern:** `requireAuth, requireAdmin`

```typescript
app.get("/api/admin/pyckers/pending", requireAuth, requireAdmin, async (req, res) => {
app.post("/api/admin/pyckers/:profileId/approve", requireAuth, requireAdmin, async (req, res) => {
app.post("/api/admin/pyckers/:profileId/reject", requireAuth, requireAdmin, async (req, res) => {
app.get("/api/admin/*", requireAuth, requireAdmin, async (req, res) => { // Any other admin routes
```

---

## HAULER-ONLY ROUTES (Require Hauler Role)

**Pattern:** `requireAuth, requireHauler`

### Availability & Check-in:
```typescript
app.patch("/api/haulers/:profileId/availability", requireAuth, requireHauler, async (req, res) => {
app.post("/api/haulers/:profileId/check-in", requireAuth, requireHauler, async (req, res) => {
app.post("/api/haulers/:profileId/check-out", requireAuth, requireHauler, async (req, res) => {
app.post("/api/haulers/:profileId/go-online", requireAuth, requireHauler, async (req, res) => {
app.post("/api/haulers/:profileId/go-offline", requireAuth, requireHauler, async (req, res) => {
```

### Profile Management:
```typescript
app.patch("/api/haulers/:profileId/profile", requireAuth, requireHauler, async (req, res) => {
app.post("/api/haulers/:profileId/vehicles", requireAuth, requireHauler, async (req, res) => {
app.patch("/api/vehicles/:vehicleId", requireAuth, requireHauler, async (req, res) => {
app.delete("/api/vehicles/:vehicleId", requireAuth, requireHauler, async (req, res) => {
```

### Job Management:
```typescript
app.get("/api/haulers/:haulerId/jobs", requireAuth, requireHauler, async (req, res) => {
app.get("/api/haulers/:haulerId/jobs/active", requireAuth, requireHauler, async (req, res) => {
app.get("/api/haulers/:haulerId/matches", requireAuth, requireHauler, async (req, res) => {
```

### Stripe Connect:
```typescript
app.post("/api/haulers/:profileId/stripe/onboard", requireAuth, requireHauler, async (req, res) => {
app.get("/api/haulers/:profileId/stripe/status", requireAuth, requireHauler, async (req, res) => {
app.post("/api/haulers/:profileId/setup-card", requireAuth, requireHauler, async (req, res) => {
```

### Rebate Claims:
```typescript
app.post("/api/rebate-claims", requireAuth, requireHauler, async (req, res) => {
app.get("/api/rebate-claims/hauler/:haulerId", requireAuth, requireHauler, async (req, res) => {
app.patch("/api/rebate-claims/:claimId", requireAuth, requireHauler, async (req, res) => {
```

---

## CUSTOMER-ONLY ROUTES (Require Customer Role)

**Pattern:** `requireAuth, requireCustomer`

### Service Requests:
```typescript
app.post("/api/service-requests", requireAuth, requireCustomer, async (req, res) => {
app.get("/api/customers/:customerId/requests", requireAuth, requireCustomer, requireOwnership("customerId"), async (req, res) => {
```

### Reviews:
```typescript
app.post("/api/reviews", requireAuth, async (req, res) => { // Both customers and haulers can review
```

---

## AUTHENTICATED USER ROUTES (Any Logged-In User)

**Pattern:** `requireAuth` (no role restriction)

### Service Request Details:
```typescript
app.get("/api/service-requests/:id", requireAuth, async (req, res) => {
app.patch("/api/service-requests/:id", requireAuth, async (req, res) => {
app.post("/api/service-requests/:id/start", requireAuth, async (req, res) => {
app.post("/api/service-requests/:id/complete", requireAuth, async (req, res) => {
app.post("/api/service-requests/:id/cancel", requireAuth, async (req, res) => {
```

### Job Photos & Issues:
```typescript
app.post("/api/jobs/upload-photos", requireAuth, async (req, res) => {
app.post("/api/jobs/:jobId/report-issue", requireAuth, async (req, res) => {
```

### Match Management:
```typescript
app.patch("/api/matches/:id", requireAuth, async (req, res) => {
app.post("/api/matches/:id/accept", requireAuth, async (req, res) => {
app.post("/api/matches/:id/decline", requireAuth, async (req, res) => {
```

### User Profile:
```typescript
app.get("/api/users/me", requireAuth, async (req, res) => {
app.patch("/api/users/me", requireAuth, async (req, res) => {
```

### Loyalty & Promotions:
```typescript
app.get("/api/promotions/:userId", requireAuth, requireOwnership("userId"), async (req, res) => {
app.get("/api/promotions/eligibility/:userId", requireAuth, requireOwnership("userId"), async (req, res) => {
app.post("/api/loyalty/redeem", requireAuth, async (req, res) => {
```

### Analytics (User-Specific):
```typescript
app.get("/api/analytics/user/:userId", requireAuth, requireOwnership("userId"), async (req, res) => {
```

---

## PUBLIC ROUTES (No Auth Required)

**Pattern:** No middleware OR `optionalAuth`

### Browse Haulers:
```typescript
app.get("/api/haulers", async (req, res) => { // Public browse
app.get("/api/haulers/available", async (req, res) => { // Public availability
app.get("/api/haulers/available/with-vehicles", async (req, res) => {
app.get("/api/haulers/search", async (req, res) => {
app.get("/api/haulers/:userId/profile", async (req, res) => { // Public profile view
app.get("/api/haulers/:profileId/vehicles", async (req, res) => { // Public vehicle list
app.get("/api/haulers/:haulerId/reviews", async (req, res) => { // Public reviews
app.get("/api/haulers/filter/:serviceType", async (req, res) => {
```

### Pricing & Quotes:
```typescript
app.post("/api/pricing/quote", async (req, res) => { // Public instant quote
app.post("/api/pricing/move-quote", async (req, res) => {
app.get("/api/pricing/supported-zips", async (req, res) => {
app.get("/api/pricing/dump-distance/:zip", async (req, res) => {
app.post("/api/pricing/ai-quote", async (req, res) => {
```

### Promo Codes:
```typescript
app.post("/api/promo-codes/validate", async (req, res) => { // Public validation
app.get("/api/promo-codes/:code", async (req, res) => {
```

### Facilities:
```typescript
app.get("/api/facilities", async (req, res) => {
app.get("/api/facilities/approved", async (req, res) => {
```

### Registration:
```typescript
app.post("/api/haulers/register", async (req, res) => { // Public PYCKER signup
```

### Analytics (Public):
```typescript
app.post("/api/analytics/track", async (req, res) => { // Public tracking
app.get("/api/analytics/funnel", async (req, res) => { // Public funnel data
```

### Service Requests (Public - for browsing):
```typescript
app.get("/api/service-requests/pending", async (req, res) => { // Haulers can see pending
```

---

## SPECIAL CASES

### Priority Slots (Authenticated + Optional Ownership):
```typescript
app.get("/api/slots/priority/:date", requireAuth, async (req, res) => {
```

### Certificates (Authenticated):
```typescript
app.post("/api/certificates/:serviceRequestId/generate", requireAuth, async (req, res) => {
```

### Business Accounts:
```typescript
app.post("/api/business-accounts", requireAuth, async (req, res) => {
app.get("/api/business-accounts/:accountId", requireAuth, async (req, res) => {
app.patch("/api/business-accounts/:accountId", requireAuth, async (req, res) => {
```

### Recurring Jobs:
```typescript
app.post("/api/recurring-jobs", requireAuth, async (req, res) => {
app.get("/api/recurring-jobs/:accountId", requireAuth, async (req, res) => {
app.patch("/api/recurring-jobs/:jobId", requireAuth, async (req, res) => {
```

---

## QUICK REFERENCE TABLE

| Route Pattern | Middleware | Who Can Access |
|--------------|-----------|----------------|
| `/api/admin/*` | `requireAuth, requireAdmin` | Admins only |
| `/api/haulers/:id/check-in` | `requireAuth, requireHauler` | Haulers only |
| `/api/haulers/:id/profile` PATCH | `requireAuth, requireHauler` | Haulers only |
| `/api/service-requests` POST | `requireAuth, requireCustomer` | Customers only |
| `/api/service-requests/:id` GET | `requireAuth` | Any logged-in user |
| `/api/haulers` GET | None | Everyone (public) |
| `/api/pricing/quote` | None | Everyone (public) |

---

## TESTING CHECKLIST

After applying auth, test these scenarios:

### Test 1: Unauthenticated Access
- [ ] Try accessing `/api/admin/pyckers/pending` without login â†’ Should get 401
- [ ] Try accessing `/api/haulers/:id/check-in` without login â†’ Should get 401
- [ ] Try accessing `/api/pricing/quote` without login â†’ Should work (public)

### Test 2: Wrong Role Access
- [ ] Login as customer, try `/api/haulers/:id/check-in` â†’ Should get 403
- [ ] Login as hauler, try `/api/admin/pyckers/pending` â†’ Should get 403
- [ ] Login as hauler, try `/api/service-requests` POST â†’ Should get 403

### Test 3: Correct Access
- [ ] Login as admin, access admin routes â†’ Should work
- [ ] Login as hauler, check in â†’ Should work
- [ ] Login as customer, create booking â†’ Should work

### Test 4: Ownership
- [ ] Login as user A, try to access user B's data â†’ Should get 403
- [ ] Login as admin, access any user's data â†’ Should work

---

## IMPLEMENTATION STEPS

1. **Copy auth-middleware.ts to `/server/auth-middleware.ts`**

2. **Add import to routes.ts:**
   ```typescript
   import { requireAuth, requireAdmin, requireHauler, requireCustomer, requireOwnership } from "./auth-middleware";
   ```

3. **Go through EVERY route** and add appropriate middleware based on this guide

4. **Test thoroughly** with different user roles

5. **Deploy** once all tests pass

---

## ESTIMATED TIME

- Applying middleware to all routes: **2-3 hours**
- Testing: **1-2 hours**
- Fixes: **1 hour**

**Total: 4-6 hours of focused work**

Then you can LAUNCH! ðŸš€